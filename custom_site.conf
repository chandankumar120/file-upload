# Redirect HTTP on port 8090 to HTTPS on port 8443
server {
    autoindex on;
    listen 8090;
    server_name vishal.webkul.in;
    return 301 https://$host:8443$request_uri;
}

# HTTPS Server Block on port 8443
server {
    autoindex on;
    listen 8443 ssl;
    server_name vishal.webkul.in;

    root /home/users/vishal.verma/www/html;
    index index.php index.html index.htm;

    ssl_certificate /etc/letsencrypt/live/webkul.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/webkul.in/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Logs
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # ---------------------------
    # CS-Cart Specific Rewrites
    # ---------------------------

    # Deny direct access to init.php
    location = /cs-cart-versions/tikke/init.php {
        deny all;
    }

    # Block favicon/apple-touch/etc if missing
    location ~* ^/(favicon|apple-touch-icon|homescreen-|firefox-icon-|coast-icon-|mstile-).*\.(png|ico)$ {
        try_files $uri =404;
    }

    # API Rewrites: /api/products â†’ api.php?_d=products
    location ~* ^/(api|.+/api)/(.*)$ {
        try_files $uri $uri/ /api.php?_d=$2;
    }

    # Main location - fallback to index.php
    location /cs-cart-versions/tikke/ {
        index index.php index.html index.htm;

        try_files $uri $uri/ /cs-cart-versions/tikke/index.php$args;
    }

    # ---------------------------
    # Static files caching + CORS
    # ---------------------------
    location ~* \.(ttf|ttc|otf|eot|woff|woff2|css|png|gif|ico|jpe?g|svg|webp)$ {
        add_header Access-Control-Allow-Origin "*";
        access_log off;
        expires 2w;
        add_header Cache-Control "max-age=1209600";
    }

    location ~* \.(jpg|jpeg|png|gif|tiff|bmp|js|css|ico|svg|webp)$ {
        access_log off;
        expires 2w;
        add_header Cache-Control "max-age=1209600";
    }

    # Handle PHP files and apply Caching Rules
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

	# Disable PHP zlib compression (use nginx gzip instead)
        fastcgi_param PHP_VALUE "zlib.output_compression=0";

	# Add a custom header to easily check cache status
        add_header X-FastCGI-Cache $upstream_cache_status;

	# Define the unique cache key.
	fastcgi_cache_key "$scheme$request_method$host$request_uri";

        # Define conditions to bypass the cache
        set $skip_cache 0;

        # 1. Bypass cache for all POST requests.
        if ($request_method = POST) {
            set $skip_cache 1;
        }

        # 2. Bypass cache if the CS-Cart session cookie is present.
        # This is the most crucial rule for a store.
        if ($http_cookie ~* "sid=") {
            set $skip_cache 1;
        }

        # 3. Bypass cache for specific dynamic URLs that should never be cached.
        if ($request_uri ~* "(/checkout|/cart|/auth.login|/auth.recover_password)") {
            set $skip_cache 1;
        }

	# Apply the cache and bypass rules
        fastcgi_cache FASTCGI_CACHE;
        fastcgi_cache_valid 200 302 60m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_use_stale error timeout invalid_header http_500;

    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-PHP-FPM "Handled by FastCGI";

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/rss+xml application/atom+xml image/svg+xml font/ttf font/otf application/font-woff application/font-woff2;
    gzip_min_length 256;
    gzip_vary on;
}

